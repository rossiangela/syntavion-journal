# ============ .github/workflows/publish-paper.yml ============
name: Publish Paper to Zenodo

on:
  push:
    paths:
      - 'papers/**'
  workflow_dispatch:
    inputs:
      paper_path:
        description: 'Path to paper directory (e.g., papers/2025/001-ml-climate)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml requests markdown jinja2

      - name: Find changed papers
        id: find-papers
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "paper_dirs=${{ github.event.inputs.paper_path }}" >> $GITHUB_OUTPUT
          else
            # Find changed paper directories
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            paper_dirs=$(echo "$changed_files" | grep '^papers/' | cut -d'/' -f1-3 | sort -u | tr '\n' ' ')
            echo "paper_dirs=$paper_dirs" >> $GITHUB_OUTPUT
          fi

      - name: Validate papers
        run: |
          for paper_dir in ${{ steps.find-papers.outputs.paper_dirs }}; do
            if [ -d "$paper_dir" ] && [ "$paper_dir" != "papers/template" ]; then
              echo "Validating $paper_dir"
              python scripts/validate_submission.py "$paper_dir"
            fi
          done

      - name: Upload to Zenodo and generate pages
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
        run: |
          for paper_dir in ${{ steps.find-papers.outputs.paper_dirs }}; do
            if [ -d "$paper_dir" ] && [ "$paper_dir" != "papers/template" ]; then
              echo "Processing $paper_dir"
              
              # Check if already has DOI
              if ! grep -q "doi:" "$paper_dir/metadata.yml" || grep -q "doi: null" "$paper_dir/metadata.yml" || grep -q "doi: \"\"" "$paper_dir/metadata.yml"; then
                echo "Uploading to Zenodo..."
                python scripts/zenodo_upload.py "$paper_dir"
              else
                echo "Paper already has DOI, skipping Zenodo upload"
              fi
              
              # Generate paper page
              python scripts/generate_paper_page.py "$paper_dir"
            fi
          done

      - name: Update archives
        run: |
          python scripts/generate_archives.py

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Syntavion Journal Bot"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“„ Published paper(s) and updated archives"
            git push
          fi

---
